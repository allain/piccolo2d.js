/**
 * Copyright (c) 2008-2013, Piccolo2D project, http://piccolo2d.org
 * Copyright (c) 1998-2008, University of Maryland
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this list of conditions
 * and the following disclaimer.
 *
 * Redistributions in binary form must reproduce the above copyright notice, this list of conditions
 * and the following disclaimer in the documentation and/or other materials provided with the
 * distribution.
 *
 * None of the name of the University of Maryland, the name of the Piccolo2D project, or the names of its
 * contributors may be used to endorse or promote products derived from this software without specific
 * prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
 * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
 * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
!function(){var a=!1,b=/xyz/.test(function(){return"xyz"})?/\b_super\b/:/.*/;Object.subClass=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.contructor=d,d.subClass=arguments.callee,d}}(),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Array.prototype.pushAll=function(a){for(var b=0;b<a.length;b+=1)this.push(a[b])},Array.prototype.remove=function(a){for(var b=[],c=0;c<this.length;c+=1)this[c]!==a&&b.push(this[c]);return b},PTransform=Object.subClass({init:function(a){this.values=a||[1,0,0,1,0,0]},scale:function(a){return this.values[0]*=a,this.values[3]*=a,this},translate:function(a,b){return this.values[4]+=a,this.values[5]+=b,this},rotate:function(a){var b=Math.cos(a),c=Math.sin(a);return this.transformBy([b,c,-c,b,0,0]),this},transformBy:function(a){var b=this.values,c=a;return a instanceof PTransform&&(c=a.values),this.values=[],this.values[0]=b[0]*c[0]+b[2]*c[1],this.values[1]=b[1]*c[0]+b[3]*c[1],this.values[2]=b[0]*c[2]+b[2]*c[3],this.values[3]=b[1]*c[2]+b[3]*c[3],this.values[4]=b[0]*c[4]+b[2]*c[5]+b[4],this.values[5]=b[1]*c[4]+b[3]*c[5]+b[5],this},applyTo:function(a){var b=this.values;a.transform(b[0],b[1],b[2],b[3],b[4],b[5])},equals:function(a){a instanceof PTransform&&(a=a.values);for(var b=0;6>b;b+=1)if(a[b]!==this.values[b])return!1;return!0},transform:function(a){if(a instanceof PPoint){var b=this.values;return new PPoint(a.x*b[0]+a.y*b[2]+b[4],a.x*b[1]+a.y*b[3]+b[5])}if(a instanceof PBounds){var c=new PPoint(a.x,a.y),d=this.transform(c),e=new PPoint(a.x+a.width,a.y+a.height),f=this.transform(e);return new PBounds(Math.min(d.x,f.x),Math.min(d.y,f.y),Math.abs(d.x-f.x),Math.abs(d.y-f.y))}if(a instanceof PTransform){var g=new PTransform(this.values);return g.transformBy(a),g}throw"Invalid argument to transform method"},getInverse:function(){var a=this.values,b=a[0]*a[3]-a[1]*a[2],c=[];return c[0]=a[3]/b,c[1]=-a[1]/b,c[2]=-a[2]/b,c[3]=a[0]/b,c[4]=(a[2]*a[5]-a[3]*a[4])/b,c[5]=-(a[0]*a[5]-a[1]*a[4])/b,new PTransform(c)},getScale:function(){var a=new PPoint(0,1),b=this.transform(a);return b.x-=this.values[4],b.y-=this.values[5],Math.sqrt(b.x*b.x+b.y*b.y)}}),PTransform.lerp=function(a,b,c){for(var d=[],e=0;6>e;e+=1)d[e]=a.values[e]+c*(b.values[e]-a.values[e]);return new PTransform(d)},window.PPoint=Object.subClass({init:function(){if(0===arguments.length)this.x=0,this.y=0;else if(1===arguments.length&&arguments[0]instanceof PPoint)this.x=arguments[0].x,this.y=arguments[0].y;else{if(2!==arguments.length)throw"Illegal argument for PPoint constructor";this.x=arguments[0],this.y=arguments[1]}}}),window.PBounds=Object.subClass({init:function(){1===arguments.length?(this.x=arguments[0].x,this.y=arguments[0].y,this.width=arguments[0].width,this.height=arguments[0].height,this.touched=!0):(this.x=arguments[0]||0,this.y=arguments[1]||0,this.width=arguments[2]||0,this.height=arguments[3]||0,this.touched=arguments.length>0)},equals:function(a){return a.x===this.x&&a.y===this.y&&a.width===this.width&&a.height===this.height},isEmpty:function(){return 0===this.width&&0===this.height},add:function(){var a,b,c,d;if(1===arguments.length){var e=arguments[0];a=e.x,b=e.y,c=e.width||0,d=e.height||0}else a=arguments[0],b=arguments[1],c=arguments[2]||0,d=arguments[3]||0;if(this.touched){var f=Math.min(a,this.x),g=Math.min(b,this.y),h={x:f,y:g,width:Math.max(this.x+this.width,a+c)-f,height:Math.max(this.y+this.height,b+d)-g};this.x=h.x,this.y=h.y,this.width=h.width,this.height=h.height}else this.x=a,this.y=b,this.width=c,this.height=d;this.touched=!0},contains:function(){var a,b;if(1===arguments.length)a=arguments[0].x,b=arguments[0].y;else{if(2!==arguments.length)throw"Invalid arguments";a=arguments[0],b=arguments[1]}return a>=this.x&&a<this.x+this.width&&b>=this.y&&b<this.y+this.height},intersects:function(a){return!(a.x+a.width<this.x||a.x>this.x+this.width||a.y+a.height<this.y||a.y>this.y+this.height)}}),PNode=Object.subClass({init:function(a){this.parent=null,this.children=[],this.listeners=[],this.fullBounds=null,this.globalFullBounds=null,this.transform=new PTransform,this.visible=!0,a?(this.fillStyle=a.fillStyle||null,this.bounds=a.bounds||new PBounds):(this.bounds=new PBounds,this.fillStyle=null)},invalidatePaint:function(){var a=this.getRoot();a&&(a.invalidPaint=!0)},paint:function(a){this.fillStyle&&!this.bounds.isEmpty()&&(a.fillStyle=this.fillStyle,a.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height))},paintAfterChildren:function(){},fullPaint:function(a){var b=!a.clipBounds||a.clipBounds.intersects(this.getGlobalFullBounds())||this.parent instanceof PCamera;if(this.visible&&b){a.save(),this.transform.applyTo(a),this.paint(a);for(var c=0;c<this.children.length;c+=1)this.children[c].fullPaint(a);this.paintAfterChildren(a),a.restore()}},scale:function(a){return this.transform.scale(a),this.fullBounds=null,this.globalFullBounds=null,this.invalidatePaint(),this},translate:function(a,b){return this.transform.translate(a,b),this.fullBounds=null,this.globalFullBounds=null,this.invalidatePaint(),this},rotate:function(a){return this.transform.rotate(a),this.invalidatePaint(),this.parent&&(this.parent.invalidateBounds(),this.globalFullBounds=null),this},addChild:function(a){return this.children.push(a),a.parent=this,this.invalidateBounds(),this.invalidatePaint(),this},removeChild:function(a){return a.parent=null,this.children=this.children.remove(a),this.invalidateBounds(),this.invalidatePaint(),this},setTransform:function(a){return this.transform=a,this.parent&&(this.parent.invalidateBounds(),this.globalFullBounds=null),this.invalidatePaint(),this},animateToTransform:function(a,b){b?this.getRoot().scheduler.schedule(new PTransformActivity(this,a,b)):this.transform=a},getRoot:function(){return this.parent?this.parent.getRoot():null},getFullBounds:function(){if(!this.fullBounds){this.layoutChildren&&this.layoutChildren();for(var a,b,c,d=new PBounds(this.bounds),e=0;e<this.children.length;e+=1)a=this.children[e],b=a.getFullBounds(),c=a.transform.transform(b),d.add(c);this.fullBounds=d}return this.fullBounds},getGlobalFullBounds:function(){if(!this.globalFullBounds){for(var a=this.getFullBounds(),b=this,c=new PPoint(a.x,a.y),d=new PPoint(a.x+a.width,a.y+a.height);b.parent;)c=b.transform.transform(c),d=b.transform.transform(d),b=b.parent;this.globalFullBounds=new PBounds(Math.min(c.x,d.x),Math.min(c.y,d.y),Math.abs(c.x-d.x),Math.abs(c.y-d.y))}return this.globalFullBounds},getGlobalTransform:function(){for(var a=new PTransform,b=this;b.parent;)a=b.transform.transform(a),b=b.parent;return a},invalidateBounds:function(){this.fullBounds=null,this.globalFullBounds=null,this.parent&&this.parent.invalidateBounds()},localToParent:function(a){return this.transform.transform(a)},parentToLocal:function(a){return this.transform.getInverse().transform(a)},addListener:function(a){-1===this.listeners.indexOf(a)&&this.listeners.push(a)},getScale:function(){return this.transform.getScale()},moveToFront:function(){return this.parent&&this.parent.children.length>1&&(this.parent.children=this.parent.children.remove(this),this.parent.children.push(this),this.invalidatePaint()),this},moveToBack:function(){if(this.parent&&this.parent.children.length>1){for(var a=[this],b=0,c=this.parent.children.length;c>b;b++)this.parent.children[b]!==this&&a.push(this.parent.children[b]);this.parent.children=a,this.invalidatePaint()}return this}}),window.PRoot=window.PNode.subClass({init:function(a){this._super(a),this.invalidPaint=!0,this.scheduler=new PActivityScheduler(25)},getRoot:function(){return this}}),window.PText=window.PNode.subClass({init:function(a){if("string"==typeof a)this._super(),this.text=a,this.recomputeBounds();else{if(!a)throw"Invalid argument for PText constructor";this.text=a.text,this._super(a),this.recomputeBounds()}},paint:function(a){this.getGlobalFullBounds().height*a.displayScale<3||(a.fillStyle=this.fillStyle?this.fillStyle:"rgb(0,0,0)",a.textBaseline="top",a.fillText(this.text,this.bounds.x,this.bounds.y))},recomputeBounds:function(){var a=PText.hiddenContext.measureText(this.text);this.bounds.width=a.width,this.bounds.height=this.text?PText.fontSize:0,this.invalidateBounds()}}),window.PText.fontSize=20,window.PText.hiddenContext=document.createElement("canvas").getContext("2d"),window.PText.hiddenContext.font=PText.fontSize+"px Arial",window.PText.hiddenContext.textBaseline="top",window.PImage=PNode.subClass({init:function(a){var b=this;"string"==typeof a?(this.url=a,this._super()):(this.url=a.url,this._super(a)),this.loaded=!1,this.image=new Image,this.image.onload=function(){b.bounds.width=this.width,b.bounds.height=this.height,b.invalidateBounds(),b.loaded=!0,b.invalidatePaint()},this.image.src=this.url},paint:function(a){this.loaded&&a.drawImage(this.image,0,0)}}),PLayer=window.PNode.subClass({init:function(a){this._super(a),this.cameras=[]},addCamera:function(a){-1===this.cameras.indexOf(a)&&this.cameras.push(a)},removeCamera:function(a){a.removeLayer(this),this.cameras=this.cameras.remove(a)}}),window.PCamera=window.PNode.subClass({init:function(){this._super(),this.layers=[],this.viewTransform=new PTransform},paint:function(a){this._super(a),a.save(),this.viewTransform.applyTo(a),a.displayScale=this.viewTransform.getScale();var b=this.viewTransform.getInverse();a.clipBounds=b.transform(this.bounds);for(var c=0;c<this.layers.length;c+=1)this.layers[c].fullPaint(a);a.restore()},addLayer:function(a){-1===this.layers.indexOf(a)&&(this.layers.push(a),a.addCamera(this)),this.invalidatePaint()},removeLayer:function(a){this.layers=this.layers.remove(a),this.invalidatePaint()},getPickedNodes:function(a,b){var c,d=this.viewTransform.getInverse(),e=new PPoint(a,b),f=d.transform(e),g=[];g.pushAll(this._getPickedNodes(this,e));for(var h=0;h<this.layers.length;h+=1)c=this.layers[h].transform.getInverse().transform(f),g.pushAll(this._getPickedNodes(this.layers[h],c));return g},_getPickedNodes:function(a,b){for(var c,d,e=[],f=0;f<a.children.length;f+=1)c=a.children[f].getFullBounds(),d=a.children[f].parentToLocal(b),c.contains(d)&&e.pushAll(this._getPickedNodes(a.children[f],d));return 0!==e.length||a instanceof PCamera?e:[a]},animateViewToTransform:function(a,b){this.getRoot().scheduler.schedule(new window.PViewTransformActivity(this,a,b))},setViewTransform:function(a){this.viewTransform=a,this.invalidatePaint()}}),window.PCanvas=Object.subClass({init:function(a,b){function c(){requestAnimationFrame(c),h.paint()}function d(a,b,c){for(var d,e,f=0,g=c.length;g>f;f+=1)for(d=c[f];d;){for(var h=0,i=d.listeners.length;i>h;h+=1)if(e=d.listeners[h],e[a]){var j=e[a]({event:b,pickedNodes:c});if(j)return}d=d.parent}}function e(a,b){for(var c=[],d=0;d<a.length;d+=1)-1===b.indexOf(a[d])&&c.push(a[d]);return c}function f(a,b,c){var f=e(a,b),g=e(b,a);d("mouseout",c,f),d("mouseover",c,g)}function g(a,b){b.preventDefault();var c=k.offset(),e=b.pageX-c.left,g=b.pageY-c.top,i=h.getPickedNodes(e,g);f(j,i,b),d(a,b,i),j=i}if("string"==typeof a&&(a=document.getElementById(a)),!a)throw"Canvas provided to Piccolo is invalid!";var h=this;this.canvas=a,a.font=PText.fontSize+"px Arial",this.root=b||new PRoot,this.camera=new PCamera,this.camera.bounds=new PBounds(0,0,a.width,a.height);var i=new PLayer;this.root.addChild(i),this.root.addChild(this.camera),this.camera.addLayer(i),setTimeout(c,0);var j=[],k=jQuery(a);k.bind("contextmenu",function(a){a.preventDefault()}),["click","mousemove","mousedown","mouseup"].forEach(function(a){k.bind(a,function(b){g(a,b)})}),k.mouseout(function(a){d("mouseout",a,j),j=[]})},paint:function(){var a=this.camera.getRoot();if(a.invalidPaint){var b=this.canvas.getContext("2d");b.font="16pt Helvetica",b.fillStyle=this.fillStyle||"rgb(255,255,255)",b.fillRect(0,0,this.canvas.width,this.canvas.height),this.camera.fullPaint(b),a.invalidPaint=!1}},getPickedNodes:function(a,b){return this.camera.getPickedNodes(a,b)}}),window.PActivity=Object.subClass({init:function(a){this.stepping=!1,"undefined"!=typeof a&&(a.init&&a.init.call(this),a.started&&(this.started=a.started),a.step&&(this.step=a.step),a.finished&&(this.finished=a.finished))},started:function(){},step:function(){},finished:function(){}}),window.PInterpolatingActivity=PActivity.subClass({init:function(a){this.stepping=!1,"undefined"!=typeof a&&(this._super(a),this.duration=a.duration?a.duration:1e3)},step:function(a){return a>=this.duration?!1:(this.interpolate(a/this.duration),!0)},interpolate:function(){}}),window.PActivityScheduler=Object.subClass({init:function(a){this.pollingRate=a,this.nextCallTime=0,this.activities=[],this.intervalID=null,this.globalTime=(new Date).getTime()},schedule:function(a,b){b=b||(new Date).getTime(),a.startTime=b,this.activities.push(a),this._start()},step:function(){var a,b=[];this.globalTime=(new Date).getTime();for(var c=0;c<this.activities.length;c+=1)a=this.activities[c],a.startTime>this.globalTime?b.push(a):(a.stepping||(a.stepping=!0,a.started()),a.step(this.globalTime-a.startTime)!==!1?b.push(a):a.finished());this.activities=b,this.activities||this._stop()},_start:function(){if(!this.intervalID){var a=this;this.intervalID=setInterval(function(){a.currentTime=(new Date).getTime(),a.step()},this.pollingRate)}},_stop:function(){this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null)}}),PTransformActivity=PInterpolatingActivity.subClass({init:function(a,b,c){this._super(),this.duration=c,this.node=a,this.source=a.transform,this.target=b},interpolate:function(a){var b=PTransform.lerp(this.source,this.target,a);this.node.setTransform(b)},finished:function(){this.node.setTransform(this.target)}}),window.PViewTransformActivity=PInterpolatingActivity.subClass({init:function(a,b,c){this._super(),this.duration=c,this.camera=a,this.source=a.viewTransform,this.target=b},interpolate:function(a){var b=PTransform.lerp(this.source,this.target,a);this.camera.setViewTransform(b)},finished:function(){this.camera.setViewTransform(this.target)}});