<html>
    <head>
        <title>Calendar Example - Piccolo2d.js</title>
        <link rel="stylesheet" href="examples.css" />
    </head>
    <body>
    <canvas id="canvas" width="800" height="600">
        <p>No Canvas Support in this browser.</p>
    </canvas>

    <script type="text/javascript" src="../lib/javascript-1.6.js"></script>
    <script type="text/javascript" src="../extends.js"></script>
    <script type="text/javascript" src="../lib/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="../piccolo2d.js"></script>
    <script type="text/javascript">
        // To deal with the case where firebug's console is not available'
        if (typeof console === "undefined") {
            console = {log: function() {}};
        }
      
        var pCanvas = new PCanvas('canvas');

        with ({
            camera: pCanvas.camera,
            layer : pCanvas.camera.layers[0]
        }) {
            var monthWidth = 600;
            var columnWidth = 600/7;

            pCanvas.fillStyle = "rgb(0, 0, 0)";

            var Day = PNode.extend({
                init: function (number) {
                    this._super({
                        bounds: new PBounds(0, 0, columnWidth*5, 500),
                        fillStyle: number ? "rgb(255, 255, 255)" : "rgb(200, 200, 200)"
                    });
                    
                    this.addChild(new PText("" + number).scale(5).translate(10, 10));
                },

                paintAfterChildren: function (ctx) {
                    ctx.strokeRect(0, 0, this.bounds.width, this.bounds.height);
                }
            });

            var Month = PNode.extend({
                init: function (year, month) {
                    this._super({
                        bounds: new PBounds(0, 0, monthWidth, 570),
                        fillStyle: "rgb(200, 200, 200)"
                    });

                    this.year = year;
                    this.month = month;

                    this.firstDay = new Date();
                    this.firstDay.setMonth(month);
                    this.firstDay.setYear(year);
                    this.firstDay.setDate(1);

                    this.lastDay = new Date();
                    this.lastDay.setMonth(month + 1);
                    this.lastDay.setYear(year);
                    this.lastDay.setDate(-1);

                    this.addChild(new PText(Month.monthNames[month]).scale(2).translate(5, 5));

                    var dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    for (var i = 0; i < dayNames.length; i += 1) {
                        this.addChild(new PText(dayNames[i]).translate(i *columnWidth, 50).scale(0.7));
                    };

                    var dayOfWeek = this.firstDay.getDay();

                    var daysInMonth = this.lastDay.getDate() - this.firstDay.getDate();

                    var columnNumber = Math.abs(dayOfWeek);
                    var currentY = 70;

                    var currentDay = 0;
                    while (currentDay < daysInMonth) {
                        var dayLabel = currentDay < 0 ? "" : (currentDay + 1);
                        this.addChild(new Day(dayLabel).translate(columnNumber*columnWidth, currentY).scale(0.2));
                        currentDay += 1;
                        columnNumber += 1;
                        
                        if (columnNumber === 7) {
                            columnNumber = 0;
                            currentY += 100;
                        }
                    }
                },

                paintAfterChildren: function (ctx) {
                    ctx.strokeRect(0, 0, this.bounds.width, this.bounds.height);
                }
            });
            Month.monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            for (var monthIndex = 0; monthIndex < 12; monthIndex ++) {
                var monthX = 10 + (monthIndex % 4)* 160;
                var monthY = 10 + ((monthIndex - (monthIndex % 4))/4)*160;

                layer.addChild(new Month(2010, monthIndex).scale(0.25).translate(monthX, monthY));
            }
            
            
            layer.addListener({
                lastFocus: null,

                click: function(event) {
                    var newFocus;

                    if (this.lastFocus == null || this.lastFocus instanceof PLayer) {
                        newFocus = event.pickedNodes[0];
                        while (!(newFocus instanceof Month)) {
                            newFocus = newFocus.parent;
                        }
                    } else {
                        newFocus = event.pickedNodes[0];
                    }

                    if (this.lastFocus === newFocus) {
                        newFocus = this.logicalParentOf(newFocus);
                    }

                    this.lastFocus = newFocus;
                    var globalTransform = newFocus.getGlobalTransform();
                    var inverse = globalTransform.getInverse();
                    camera.animateViewToTransform(inverse, 500);
                },

                logicalParentOf: function(node) {
                    if (node instanceof PLayer) {
                        return node;
                    }
                    
                    do {
                        node = node.parent;
                    } while (!(node instanceof Month || node instanceof PLayer));

                    return node;
                }
            });
        }
    </script>
    <h1>Calendar Example</h1>
    <p>Benchmarking example mostly.</p>
</body>
</html>
